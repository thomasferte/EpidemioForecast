---
title: "Experience 1 - reporting"
format: gfm
toc: true
number-sections: true
editor: source
echo: false
message: false
warning: false
prefer-html: true
---

```{r}
set.seed(1)
library(tidyverse)
source(here::here("script/fct_compute_performance.R"))
```

```{r}
path_experience1 <- here::here("output/experience1/aggregated_results/")
color_methods <- viridis::inferno(n = 3, end = 0.9)
```

# Introduction

Goal = provide some results to write the article of the SARS-CoV-2 forecast from an implementation science perspective.

Hypothesis to test :

- Simple models like elastic-net perform better when little information is available
- Feature selection based on epidemic knowledge performs better when little information is available
- More complex models like xgboost or reservoir computing show an advantage only on the late phase of the epidemic
- Simple models are faster and have lighter carbon footprint

# Methods

Same setting as ICML paper.

We compare different scenario :

- 3 methods : elastic-net, xgboost, reservoir computing
- 2 features selection : all features provided (GA feature selection for reservoir computing), epidemiology informed features selection (no GA feature selection for reservoir computing).
- monthly update and no monthly update
- two period : one starts on 2020-09-02, the other one starts on 2021-03-01

Expected results:

- Elastic-net > xgboost on early period
- Reservoir computing > Elastic-net on all period (add memory and non linearity)
- XGboost ~= Reservoir computing on late period (complex models are better in late period)
- Epidemio feature selection > Data driven feature selection on early period (add expert knowledge has strong importance in the early period)
- Elastic-net carbon footprint and time <<<<< XGboost and Reservoir computing

# Prediction

```{r}
##### IMPORT FILES
ls_prediction_performance <- fct_compute_prediction(path_files = path_experience1)

df_performance <- fct_compute_performance(df_prediction_by_day = ls_prediction_performance$df_prediction_by_day)
```

### Sanity check

First, we check that there is 40 reservoir prediction for each day of
the prediction for each scenario. We observe that there is indeed a
forecast for each day. Some days have less than 40 reservoirs but the
minimum is 39 which seems acceptable.

```{r sanitycheckNbReservoirPerDay}
#| fig-cap: "Number of reservoir per day for prediction"
#| fig-height: 4
#| 
ls_prediction_performance$df_prediction %>%
  group_by(hp_date, model, outcomeDate, features, starting_date, update) |> 
  summarise(n = n(), .groups = "drop") %>%
  full_join(expand.grid(update = unique(ls_prediction_performance$df_prediction$update),
                        model = unique(ls_prediction_performance$df_prediction$model),
                        outcomeDate = unique(ls_prediction_performance$df_prediction$outcomeDate),
                        features = unique(ls_prediction_performance$df_prediction$features),
                        starting_date = unique(ls_prediction_performance$df_prediction$starting_date)),
            by = c("update",
                   "model",
                   "outcomeDate",
                   "features",
                   "starting_date")) %>%
  filter(outcomeDate >= as.Date(starting_date)+14) %>%
  mutate(model_string = paste(model,
                              features,
                              sep = "_"),
         n = if_else(is.na(n), 0, n)) %>%
  ggplot(mapping = aes(x = outcomeDate,
                       y = n,
                       color = update,
                       shape = update)) +
  geom_line() +
  scale_color_manual(values = c("black", "grey")) +
  scale_y_continuous(labels = round,
                     breaks = round) +
  facet_grid(model_string ~ starting_date, scales = "free_y") +
  theme_bw() +
  theme(strip.text.y = element_text(angle = 0)) +
  labs(x = "Date", y = "Number of models")
```

### Prediction

```{r PredictionByDayByModel}
#| fig-cap: "Prediction by day by model"
#| fig-height: 10

make_plot_daily_prediction <- function(string_date, data){
  data %>%
  filter(starting_date == string_date) %>%
  mutate(pred = if_else(pred > 200, 200, pred)) %>%
  ggplot(mapping = aes(x = outcomeDate, y = pred, color = features)) +
  geom_line() +
  geom_line(mapping = aes(y = hosp, color = "Baseline")) +
  geom_line(mapping = aes(y = outcome, color = "Observed"), na.rm = TRUE) +
  scale_color_viridis_d(option = "rocket", end = .85, direction = -1) +
  scale_y_continuous(limits = c(0, 200)) +
  scale_x_date(breaks = "3 months") +
  facet_grid(model ~ update) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Date",
       y = "Hospitalizations",
       color = "Model",
       linetype = "Features")
}

plot_early <- make_plot_daily_prediction(string_date = "2020-09-02",
                                         data = ls_prediction_performance$df_prediction_by_day) +
  ggtitle('A. Models start at 2020-09-02')
plot_late <- make_plot_daily_prediction(string_date = "2021-03-01",
                                        data = ls_prediction_performance$df_prediction_by_day) +
  ggtitle('B. Models start at 2021-03-01')

ggpubr::ggarrange(plot_early, plot_late, common.legend = TRUE, legend = "right", ncol = 1, nrow = 2)
```

### Performance

#### Forecast Error by month

```{r}
#| fig-cap: "Forecast performance by month depending on model, update frequency and features used. Erros greater than 50 are set to 50 for visualisation."
#| fig-height: 4
#| 
ls_prediction_performance$df_performance_by_month %>%
  mutate(MAE = if_else(MAE > 50, 50, MAE)) %>%
  ggplot(mapping = aes(x = outcomeMonth, y = MAE, color = model, shape = features)) +
  geom_point() +
  scale_color_manual(values = color_methods) +
  facet_grid(update ~ starting_date) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Month",
       y = "Mean Absolute Error",
       color = "Model",
       shape = "Features")
```

```{r}
#| fig-cap: "Mean Absoluter Error compared to baseline by month depending on model, update frequency and features used. Models below horitzontal line underperform compared to baseline model and therefore are useless. Erros greater than 10 are set to 10 for visualisation."
#| fig-height: 4
#| 
ls_prediction_performance$df_performance_by_month %>%
  mutate(MAEB = if_else(MAEB > 10, 10, MAEB)) %>%
  ggplot(mapping = aes(x = outcomeMonth, y = MAEB, color = model, shape = features)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  scale_color_manual(values = color_methods) +
  facet_grid(update ~ starting_date) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Month",
       y = "Mean Absolute Error compared to Baseline",
       color = "Model",
       shape = "Features")
```

#### Overall performance

```{r}
#| tbl-cap: "Performance by algorithm initiated in 2020-09-02 from 2020-09-02 to 2021-03-15"
ls_prediction_performance$df_prediction_by_day %>%
  filter(outcomeDate < "2021-03-15") %>%
  fct_compute_performance() %>%
  dplyr::select(model, features, update, MAE, MRE, MAEB, MREB, starting_date) %>%
  gt::gt(
    rowname_col = "features",
    groupname_col = "model",
    row_group_as_column = TRUE
  )
```

```{r}
#| tbl-cap: "Performance by algorithm initiated in 2021-03-01 from 2021-03-15 to 2022-01-17."
ls_prediction_performance$df_prediction_by_day %>%
  filter(starting_date == "2021-03-01") %>%
  fct_compute_performance() %>%
  dplyr::select(model, features, update, MAE, MRE, MAEB, MREB, starting_date) %>%
  gt::gt(
    rowname_col = "features",
    groupname_col = "model",
    row_group_as_column = TRUE
  )
```

```{r overallPerf}
#| fig-cap: "Performance by algorithm initiated in 2021-03-01 from 2021-03-15 to 2022-01-17. Erros greater than 25 are set to 25 for visualisation."
#| fig-height: 3
#| 
graph_perf <- ls_prediction_performance$df_prediction_by_day %>%
  fct_compute_performance() %>%
  filter(starting_date == "2021-03-01") %>%
  mutate(AE = if_else(AE > 25, 25, AE)) %>%
  ggplot(mapping = aes(x = features, y = AE, color = model)) +
  geom_point(position = position_dodge(width = .5)) +
  scale_color_manual(values = color_methods) +
  theme_bw() +
  facet_grid(. ~ update, scales = "free_y") +
  labs(y = "Mean absolute error",
       x = "Features",
       color = "Model")

graph_perf
```

# Hyperparameters

```{r}
vec_numeric_hp <- c("n_estimators",
                    "max_depth",
                    "learning_rate",
                    "subsample",
                    "colsample_bytree",
                    "spectral_radius",
                    "leaking_rate",
                    "input_scaling",
                    "ridge",
                    "l1_ratio")
vec_log_hp <- c("learning_rate",
                "ridge",
                "spectral_radius",
                "input_scaling",
                "leaking_rate")

files_hyperparameters <- list.files(path = path_experience1,
                                    full.names = TRUE,
                                    pattern = "_hyperparameters")
names(files_hyperparameters) <- list.files(path = path_experience1,
                                           pattern = "_hyperparameters")

bool_20200815 <- grepl(pattern = "2020-08-15", x = names(files_hyperparameters))
files_hyperparameters <- files_hyperparameters[!bool_20200815]
  
df_hyperparameters <- lapply(names(files_hyperparameters),
                             function(name_file_i) readr::read_csv(files_hyperparameters[name_file_i]) %>%
                               mutate(across(.cols = any_of(vec_numeric_hp),
                                             .fns = as.numeric)) %>%
                               mutate(model = name_file_i,
                                      .before = 1) %>%
                               na.omit()) |>
  bind_rows() %>%
  tibble::rowid_to_column(var = "genetic_id") |>
  separate(model,
           sep = "_",
           into = c("trash_method",
                    "model",
                    "trash_date",
                    "starting_date",
                    "trash_features",
                    "features",
                    "trash_prediction")) %>%
  select(-starts_with("trash_")) %>%
  mutate(last_used_observation = stringr::str_extract(string = file_hp,
                                                      pattern = "\\d{4}-\\d{2}-\\d{2}"),
         last_used_observation = as.Date(last_used_observation)) %>%
  filter(value != 1000) %>%
  select(genetic_id, value, model, starting_date, features, last_used_observation, all_of(vec_numeric_hp))

## get the best 40 by date
fct_format_num_hp <- function(dfhp){
  dfhp %>%
    ungroup() %>%
    select(-value) %>%
    tidyr::pivot_longer(cols = all_of(vec_numeric_hp), names_to = "hyperparameter") |>
    mutate(last_used_observation = as.factor(last_used_observation),
         last_used_observation = forcats::fct_rev(last_used_observation),
         value = if_else(hyperparameter %in% vec_log_hp,
                         log10(value),
                         value),
         hyperparameter = if_else(hyperparameter %in% vec_log_hp,
                                  paste0("log10(", hyperparameter, ")"),
                                  hyperparameter)) %>%
    na.omit()
}

df_all_hp <- df_hyperparameters %>%
  fct_format_num_hp()

df_all_hp_best40 <- df_hyperparameters %>%
  group_by(model, starting_date, features, last_used_observation) %>%
  slice_min(value, n = 40) |>
  fct_format_num_hp() |> 
  mutate(last_used_observation = forcats::fct_rev(last_used_observation))

df_all_hp_best1 <- df_hyperparameters %>%
  group_by(model, starting_date, features, last_used_observation) %>%
  slice_min(value, n = 1) |>
  fct_format_num_hp() |> 
  mutate(last_used_observation = forcats::fct_rev(last_used_observation))

```


## Sanity check

```{r}
#| fig-cap: "Numbers of trial per model and date. Sanity check."
#| fig-height: 6
#| 
df_hyperparameters |>
  filter(value != 1000) %>%
  group_by(last_used_observation, model, starting_date, features) |>
  summarise(n = n(), .groups = "drop") |>
  ggplot(mapping = aes(x = last_used_observation, y = n, fill = model)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(starting_date ~ features) +
  scale_fill_manual(values = color_methods) +
  labs(y = "nb of genetic individuals",
       x = "update date") +
  theme_bw()
```

```{r}
#| fig-cap: "Q1-Q3 distribution of numeric hyperparameters. Sanity check."
#| fig-height: 12
#| 
df_all_hp %>%
  group_by(model, starting_date, features, last_used_observation, hyperparameter) %>%
  summarise(q1 = quantile(value, 0.25),
            q3 = quantile(value, 0.75)) %>%
  ggplot(mapping = aes(xmin = q1, xmax = q3, y = last_used_observation,
                       color = interaction(features, starting_date))) +
  geom_errorbarh() +
  scale_color_viridis_d(option = "A", end = 0.9) +
  facet_wrap(model ~ hyperparameter, scales = "free_x", ncol = 3) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(color = "Features x Starting date") +
  guides(color=guide_legend(nrow=2,byrow=TRUE))

```

## Numeric hyperparameters

### Hyperparameter evolution

```{r}
#| fig-cap: "Numeric hyperparameter, density of 40 best individuals per hyperparameter update date."
#| fig-height: 10
#| 

plot_best_numeric_hp_reservoir <- df_all_hp_best40 |>
  filter(model == "reservoir") %>%
  ggplot(mapping = aes(x = value,
                       y = features,
                       color = last_used_observation)) +
  geom_point(position = position_dodge2(width = .4, reverse = TRUE)) +
  geom_point(data = df_all_hp_best1 %>% filter(model == "reservoir"),
             position = position_dodge2(width = .4, reverse = TRUE),
             mapping = aes(color = "Best")) +
  scale_color_manual(values = c(viridis::viridis(n = 17), "black")) +
  facet_grid(starting_date ~ hyperparameter, scales = "free_x", switch = "both") +
  theme_bw() +
  labs(x = "Hyperparameter value",
       y = "Update Date",
       color = "HP update")

plot_best_numeric_hp_xgboost <- df_all_hp_best40 |>
  filter(model == "xgboost") %>%
  ggplot(mapping = aes(x = value,
                       y = features,
                       color = last_used_observation)) +
  geom_point(position = position_dodge2(width = .4, reverse = TRUE)) +
  geom_point(data = df_all_hp_best1 %>% filter(model == "xgboost"),
             position = position_dodge2(width = .4, reverse = TRUE),
             mapping = aes(color = "Best")) +
  scale_color_manual(values = c(viridis::viridis(n = 17), "black")) +
  facet_grid(starting_date ~ hyperparameter, scales = "free_x", switch = "both") +
  theme_bw() +
  labs(x = "Hyperparameter value",
       y = "Update Date",
       color = "HP update")

plot_best_numeric_hp_enet <- df_all_hp_best40 |>
  filter(model == "enet") %>%
  ggplot(mapping = aes(x = value,
                       y = features,
                       color = last_used_observation)) +
  geom_point(position = position_dodge2(width = .4, reverse = TRUE)) +
  geom_point(data = df_all_hp_best1 %>% filter(model == "enet"),
             position = position_dodge2(width = .4, reverse = TRUE),
             mapping = aes(color = "Best")) +
  scale_color_manual(values = c(viridis::viridis(n = 17), "black")) +
  facet_grid(starting_date ~ hyperparameter, scales = "free_x", switch = "both") +
  theme_bw() +
  labs(x = "Hyperparameter value",
       y = "Update Date",
       color = "HP update")


ggpubr::ggarrange(plot_best_numeric_hp_reservoir,
                  plot_best_numeric_hp_enet,
                  plot_best_numeric_hp_xgboost,
                  nrow = 3,
                  ncol = 1,
                  common.legend = TRUE,
                  legend = "bottom")

```

# Time and carbon footprint

```{r}
file_emissions = paste0(path_experience1, "emissions_logs.csv")
vec_time_labeller <- c("CO2eq (kg)",
                       "Energy (kWh)",
                       "Time (h)")
names(vec_time_labeller) <- c("total_max_emissions",
                              "total_max_energy",
                              "total_max_time")

df_emissions <- readr::read_csv(file_emissions) %>%
  separate(project_name,
           sep = "_",
           into = c("trash_method",
                    "model",
                    "trash_date",
                    "starting_date",
                    "trash_features",
                    "features",
                    "trash_prediction")) %>%
  select(-starts_with("trash_")) %>%
  filter(starting_date != "2020-08-15") %>%
  mutate(train_test = factor(grepl(x = file_hp,
                                   pattern = "evaluate_id_test_"),
                             levels = c(TRUE, FALSE),
                             labels = c("Test", "Train"))) %>%
  group_by(model, starting_date, features, train_test) %>%
  summarise(mean_emissions = mean(emissions),
            mean_energy = mean(energy_consumed),
            mean_time = mean(duration)/3600,
            nb_jobs = n(),
            .groups = "drop") %>%
  mutate(theoric_nb_jobs = case_when(train_test == "Test" & starting_date == "2020-09-02" ~ 18,
                                     train_test == "Test" & starting_date == "2021-03-01" ~ 11,
                                     train_test == "Train" ~ 200),
         total_max_emissions = mean_emissions * theoric_nb_jobs,
         total_max_energy = mean_energy * theoric_nb_jobs,
         total_max_time = mean_time * theoric_nb_jobs)
```

```{r}
#| fig-cap: "Execution time, energy consumption and carbon footprint by algorithm starting at 2021-03-01.."
#| fig-height: 6
#| 
df_emissions %>%
  filter(starting_date == "2021-03-01") %>%
  select(model, starting_date, features, train_test, starts_with("total")) %>%
  tidyr::pivot_longer(cols = starts_with("total")) %>%
  ggplot(mapping = aes(x = features, y = value, color = model)) +
  geom_point(position = position_dodge(width = .5)) +
  scale_color_manual(values = color_methods) +
  facet_wrap(name ~ train_test,
             scales = "free_y",
             labeller = labeller(name = vec_time_labeller),
             ncol = 2) +
  theme_bw() +
  labs(shape = "Train or test set",
       color = "Model",
       x = "Features")

```

```{r}
#| fig-cap: "Mean Absolute Error and Carbon footprint by algorithm starting at 2021-03-01."
#| fig-height: 4
#| 
df_performance_vs_CO2_tempCO2 <- df_emissions %>%
  group_by(model, starting_date, features) %>%
  summarise(total_max_emissions = sum(total_max_emissions),
            .groups = "drop")

df_performance_vs_CO2 <- ls_prediction_performance$df_prediction_by_day %>%
  fct_compute_performance() %>%
  filter(update == "Monthly update",
         starting_date == "2021-03-01") %>%
  select(model, starting_date, features, AE) %>%
  left_join(df_performance_vs_CO2_tempCO2,
            by = c("model", "starting_date", "features"))

df_performance_vs_CO2 %>%
  ggplot(mapping = aes(x = total_max_emissions, y = AE, color = model, shape = features)) +
  geom_point(size = 3) +
  scale_color_manual(values = color_methods) +
  scale_shape_manual(values = c(8, 18)) +
  theme_bw() +
  labs(x = "train + test CO2eq (kg)",
       y = "Mean Absolute Error",
       color = "Model",
       shape = "Features")
```

