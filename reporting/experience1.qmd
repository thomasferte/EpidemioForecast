---
title: "Experience 1 - reporting"
format: gfm
editor: source
echo: false
message: false
warning: false
prefer-html: true
---

```{r}
set.seed(1)
library(tidyverse)
source(here::here("script/fct_compute_performance.R"))
```

```{r}
path_experience1 <- here::here("output/experience1/aggregated_results/")
color_methods <- c("#94C9A9", "#FB8B24", "#454372", "black", "darkgrey")
```

# PREDICTION

```{r}
##### IMPORT FILES
ls_prediction_performance <- fct_compute_prediction(path_files = path_experience1)

df_performance <- fct_compute_performance(df_prediction_by_day = ls_prediction_performance$df_prediction_by_day)
```

### Sanity check

First, we check that there is 40 reservoir prediction for each day of
the prediction for each scenario. We observe that there is indeed a
forecast for each day. Some days have less than 40 reservoirs but the
minimum is 39 which seems acceptable.

```{r sanitycheckNbReservoirPerDay}
#| fig-cap: "Number of reservoir per day for prediction"
#| fig-height: 6
#| 
ls_prediction_performance$df_prediction %>%
  group_by(hp_date, model, outcomeDate, features, starting_date, update) |> 
  summarise(n = n(), .groups = "drop") %>%
  full_join(expand.grid(update = unique(ls_prediction_performance$df_prediction$update),
                        model = unique(ls_prediction_performance$df_prediction$model),
                        outcomeDate = unique(ls_prediction_performance$df_prediction$outcomeDate),
                        features = unique(ls_prediction_performance$df_prediction$features),
                        starting_date = unique(ls_prediction_performance$df_prediction$starting_date)),
            by = c("update",
                   "model",
                   "outcomeDate",
                   "features",
                   "starting_date")) %>%
  mutate(model_string = paste(model,
                              features,
                              sep = "_")) %>%
  ggplot(mapping = aes(x = outcomeDate,
                       y = n,
                       color = update)) +
  geom_line() +
  facet_grid(model_string ~ starting_date, scales = "free_y") +
  theme_bw() +
  theme(strip.text.y = element_text(angle = 0)) +
  labs(x = "Date", y = "Nb of models")
```

### Prediction

```{r PredictionByDayByModel}
#| fig-cap: "Prediction by day by model"
#| fig-height: 8
#| 
ls_prediction_performance$df_prediction_by_day %>%
  mutate(pred = if_else(pred > 200, 200, pred)) %>%
  ggplot(mapping = aes(x = outcomeDate, y = pred, color = model, linetype = features)) +
  geom_line() +
  geom_line(mapping = aes(y = outcome, color = "Observed"), na.rm = TRUE) +
  geom_line(mapping = aes(y = hosp, color = "Baseline")) +
  scale_color_manual(values = color_methods) +
  scale_y_continuous(limits = c(0, 200)) +
  scale_x_date(breaks = "2 months") +
  facet_grid(update ~ starting_date) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Date",
       y = "Hospitalizations",
       color = "Model",
       linetype = "Features")
```


### Performance

#### Forecast Error by month

```{r}
ls_prediction_performance$df_performance_by_month %>%
  ggplot(mapping = aes(x = outcomeMonth, y = MAE, color = model, shape = features)) +
  geom_point() +
  scale_color_manual(values = color_methods) +
  scale_y_log10() +
  facet_grid(update ~ starting_date) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Month",
       y = "Mean Absolute Error",
       color = "Model",
       shape = "Features")
```

```{r}
ls_prediction_performance$df_performance_by_month %>%
  mutate(MAEB = if_else(MAEB > 10, 10, MAEB)) %>%
  ggplot(mapping = aes(x = outcomeMonth, y = MAEB, color = model, shape = features)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  scale_color_manual(values = color_methods) +
  facet_grid(update ~ starting_date) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Month",
       y = "Mean Absolute Error compared to Baseline",
       color = "Model",
       shape = "Features")
```

#### Overall performance

```{r}
#| tbl-cap: "Performance by algorithm initiated in 2020-08-15 from 2020-08-29 to 2021-03-15"
ls_prediction_performance$df_prediction_by_day %>%
  filter(outcomeDate < "2021-03-15") %>%
  fct_compute_performance() %>%
  dplyr::select(model, features, update, MAE, MRE, MAEB, MREB, starting_date) %>%
  gt::gt(
    rowname_col = "features",
    groupname_col = "model",
    row_group_as_column = TRUE
  )
```

```{r}
#| tbl-cap: "Performance by algorithm initiated in 2021-03-01 from 2021-03-15 to 2022-01-17."
ls_prediction_performance$df_prediction_by_day %>%
  filter(starting_date == "2021-03-01") %>%
  fct_compute_performance() %>%
  dplyr::select(model, features, update, MAE, MRE, MAEB, MREB, starting_date) %>%
  gt::gt(
    rowname_col = "features",
    groupname_col = "model",
    row_group_as_column = TRUE
  )
```

```{r overallPerf}
#| fig-cap: "Overall performance of the different methods"
#| fig-height: 6
#| 
graph_perf <- ls_prediction_performance$df_prediction_by_day %>%
  fct_compute_performance() %>%
  ggplot(mapping = aes(x = features, y = AE, color = model)) +
  geom_point(position = position_dodge(width = .5)) +
  scale_color_manual(values = color_methods) +
  theme_bw() +
  facet_grid(starting_date ~ update, scales = "free_y") +
  labs(y = "Mean absolute error",
       x = "Features",
       color = "Update")

graph_perf
```

# Hyperparameters

```{r}
vec_numeric_hp <- c("n_estimators",
                    "max_depth",
                    "learning_rate",
                    "subsample",
                    "colsample_bytree",
                    "spectral_radius",
                    "leaking_rate",
                    "input_scaling",
                    "ridge",
                    "l1_ratio")

files_hyperparameters <- list.files(path = path_experience1,
                                    full.names = TRUE,
                                    pattern = "_hyperparameters")
names(files_hyperparameters) <- list.files(path = path_experience1,
                                           pattern = "_hyperparameters")

df_hyperparameters <- lapply(names(files_hyperparameters),
                             function(name_file_i) readr::read_csv(files_hyperparameters[name_file_i]) %>%
                               mutate(across(.cols = any_of(vec_numeric_hp),
                                             .fns = as.numeric)) %>%
                               mutate(model = name_file_i,
                                      .before = 1)) |>
  bind_rows() %>%
  tibble::rowid_to_column(var = "genetic_id") |>
  separate(model,
           sep = "_",
           into = c("trash_method",
                    "model",
                    "trash_date",
                    "starting_date",
                    "trash_features",
                    "features",
                    "trash_prediction")) %>%
  select(-starts_with("trash_")) %>%
  mutate(last_used_observation = stringr::str_extract(string = file_hp,
                                                      pattern = "\\d{4}-\\d{2}-\\d{2}"),
         last_used_observation = as.Date(last_used_observation))

## get the best 40 by date
df_all_hp_best40 <- df_hyperparameters %>%
  group_by(model, starting_date, features, last_used_observation) %>%
  slice_min(value, n = 40) |>
  ungroup() %>%
  select(model, starting_date, features, last_used_observation, all_of(vec_numeric_hp)) |>
  tidyr::pivot_longer(cols = all_of(vec_numeric_hp), names_to = "hyperparameter") |>
  mutate(last_used_observation = as.factor(last_used_observation),
         last_used_observation = forcats::fct_rev(last_used_observation))
```


## Sanity check

```{r}
df_hyperparameters |>
  group_by(last_used_observation, model, starting_date, features) |>
  summarise(n = n(), .groups = "drop") |>
  ggplot(mapping = aes(x = last_used_observation, y = n, fill = model)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(starting_date ~ features) +
  scale_fill_manual(values = color_methods) +
  labs(y = "nb of genetic individuals",
       x = "update date") +
  theme_minimal()
```

## Numeric hyperparameters

### Hyperparameter evolution

```{r fig.height=8, fig.cap="Numeric hyperparameter, density of 40 best genetic individuals per hyperparameter update date."}

plot_best_numeric_hp_reservoir <- df_all_hp_best40 |>
  filter(model == "reservoir") %>%
  ggplot(mapping = aes(x = value,
                       y = last_used_observation,
                       group = interaction(last_used_observation, hyperparameter),
                       fill = hyperparameter,
                       color = hyperparameter)) +
  ggridges::geom_density_ridges(alpha = 0.5) +
  facet_wrap(starting_date ~ features, scales = "free_y", switch = "both") +
  scale_x_log10(breaks = c(1e-10, 1e-5, 1, 1e5)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "Hyperparameter value",
       y = "Update Date")

plot_best_numeric_hp_xgboost <- df_all_hp_best40 |>
  filter(model == "xgboost") %>%
  ggplot(mapping = aes(x = value,
                       y = last_used_observation,
                       group = interaction(last_used_observation, hyperparameter),
                       fill = hyperparameter,
                       color = hyperparameter)) +
  ggridges::geom_density_ridges(alpha = 0.5) +
  facet_wrap(starting_date ~ features, scales = "free_y", switch = "both") +
  scale_x_log10(breaks = c(1e-10, 1e-5, 1, 1e5)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "Hyperparameter value",
       y = "Update Date")

plot_best_numeric_hp_enet <- df_all_hp_best40 |>
  filter(model == "enet") %>%
  ggplot(mapping = aes(x = value,
                       y = last_used_observation,
                       group = interaction(last_used_observation, hyperparameter),
                       fill = hyperparameter,
                       color = hyperparameter)) +
  ggridges::geom_density_ridges(alpha = 0.5) +
  facet_wrap(starting_date ~ features, scales = "free_y", switch = "both") +
  scale_x_log10(breaks = c(1e-10, 1e-5, 1, 1e5)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = "Hyperparameter value",
       y = "Update Date")

ggpubr::ggarrange(plot_best_numeric_hp_reservoir,
                  plot_best_numeric_hp_enet,
                  plot_best_numeric_hp_xgboost,
                  nrow = 3,
                  ncol = 1)

```

## Categorical hyperparameters

```{r fig.height=6, fig.cap="Number of selected features among the best genetic individuals."}
df_all_hp_best40_qual <- df_all_hp |>
  select(genetic_id, model, last_used_observation, ends_with("_bin"))

temp <- df_all_hp_best40_qual |>
  tidyr::pivot_longer(cols = ends_with("_bin")) |>
  filter(!(is.na(value) & model == "Epidemio")) |>
  group_by(genetic_id, model, last_used_observation) |>
  summarise(n_features = sum(value == "y"), .groups = "drop") |>
  mutate(last_used_observation = as.factor(last_used_observation)) |>
  group_by(model, last_used_observation) |>
  summarise(median = median(n_features),
            q1 = quantile(n_features, .25),
            q3 = quantile(n_features, .75),
            .groups = "drop")

plot_nb_features <- temp |>
  ggplot(mapping = aes(color = model,
                       y = median,
                       ymin = q1,
                       ymax = q3,
                       x = last_used_observation,
                       group = model)) +
  geom_errorbar(width = 0, position = position_dodge(width=.5)) +
  geom_point(position = position_dodge(width=.5)) +
  geom_line(position = position_dodge(width=.5)) +
  scale_color_manual(values = c("#BB3E03", "#005F73", "#0A9396", "#94D2BD", "#EE9B00")) +
  scale_y_continuous(breaks = seq(0,400, by =20)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Date",
       y = "Number of selected features",
       color = "P(mutation categorical genes)")

plot_nb_features
```

```{r}
df_all_hp_best40_qual |>
  filter(last_used_observation %in% as.Date(c("2021-03-01", "2022-01-01"))) |>
  tidyr::pivot_longer(cols = ends_with("_bin")) |>
  filter(!is.na(value)) |>
  group_by(genetic_id, model, last_used_observation) |>
  summarise(n_features = sum(value == "y"), .groups = "drop") |>
  mutate(last_used_observation = as.factor(last_used_observation)) |>
  group_by(model, last_used_observation) |>
  summarise(mean = round(mean(n_features), 1),
            sd = round(sd(n_features), 1),
            .groups = "drop") |>
  mutate(mean_sd = paste0(mean, "(\u00B1 ", sd, ")")) |>
  select(model, last_used_observation, mean_sd) |>
  tidyr::pivot_wider(names_from = last_used_observation, values_from = mean_sd) |>
  knitr::kable(caption = "Number of features selected at first and last month. Mean (sd)") |>
  kableExtra::kable_styling()
```

```{r freqselectionfeatures, fig.height=4}
df_freq_selection <- df_all_hp_best40_qual |>
  tidyr::pivot_longer(cols = ends_with("_bin")) |>
  filter(!(is.na(value) & model == "Epidemio")) |>
  group_by(model, last_used_observation, name) |>
  summarise(value = mean(value == "y"), .groups = "drop") |>
  mutate(last_used_observation = as.factor(last_used_observation))

plot_distribution_feature_selection <- ggplot(df_freq_selection,
                                              mapping = aes(x = value,
                                                            fill = last_used_observation,
                                                            color = last_used_observation,
                                                            y = model,
                                                            group = interaction(model, last_used_observation))) +
  ggridges::geom_density_ridges(alpha = 0.2) +
  geom_vline(xintercept = .5, linetype = 2, color = "darkgrey") +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  scale_x_continuous(limits = c(0,1),
                     breaks = c(0, .5, 1)) +
  labs(y = "",
       x = "Frequency of feature selection",
       fill = "Date update",
       color = "Date update") +
  theme_minimal()
```

<!-- ```{r fig.height=8} -->

<!-- df_plot <- df_freq_selection |>  -->

<!--   filter(model == "Epidemio") |>  -->

<!--   group_by(name) |>  -->

<!--   mutate(mean_prop = sum(value*(last_used_observation == "2022-01-01"))) |> -->

<!--   ungroup() |>  -->

<!--   mutate(name = FctCleanFeaturesName(name), -->

<!--          name = as.factor(name), -->

<!--          name = forcats::fct_reorder(name, -mean_prop), -->

<!--          deriv = grepl(name, pattern = "(1st d)"), -->

<!--          deriv = factor(deriv, -->

<!--                         levels = c(F,T), -->

<!--                         labels = c("Raw", "1st derivative"))) -->

<!-- ggplot(data = df_plot, -->

<!--        mapping = aes(y = value, -->

<!--                      x = last_used_observation, -->

<!--                      group = name, -->

<!--                      label = name, -->

<!--                      color = name)) + -->

<!--   geom_line() + -->

<!--   geom_text_repel(data = df_plot |>  -->

<!--                     filter(last_used_observation == "2022-01-01"), -->

<!--                   size = 3, -->

<!--                   nudge_x = 6, -->

<!--                   direction = "y", -->

<!--                   force = 5, -->

<!--                   arrow = arrow(length = unit(0.01, "npc"), type = "closed")) + -->

<!--   scale_y_continuous(breaks = c(0,.5,1), limits = c(0,1)) + -->

<!--   scale_color_viridis_d(option = "B", end = 0.85) + -->

<!--   theme_minimal() + -->

<!--   theme(axis.text.x = element_text(angle = 90), -->

<!--         legend.position = "none") + -->

<!--   labs(y = "Frequency of feature selection", -->

<!--        x = "Date update") -->

<!-- ``` -->

```{r fig.height=8}
df_plot <- df_freq_selection |>
  filter(model == "Mutation adaptation") |>
  group_by(name) |>
  mutate(mean_prop = sum(value*(last_used_observation == "2022-01-01"))) |>
  ungroup() |>
  mutate(name = FctCleanFeaturesName(name),
         name = as.factor(name),
         name = forcats::fct_reorder(name, -mean_prop),
         deriv = grepl(name, pattern = "(1st d)"),
         deriv = factor(deriv,
                        levels = c(F,T),
                        labels = c("Raw", "1st derivative")))

ggplot(data = df_plot,
       mapping = aes(y = value,
                     x = last_used_observation,
                     group = name,
                     label = name,
                     color = name)) +
  geom_line() +
  geom_text_repel(data = df_plot |>
                    filter(last_used_observation == "2022-01-01") |>
                    filter(value > 0.25),
                  size = 3,
                  nudge_x = 6,
                  direction = "y",
                  force = 5,
                  arrow = arrow(length = unit(0.01, "npc"), type = "closed")) +
  scale_y_continuous(breaks = c(0,.5,1), limits = c(0,1)) +
  scale_color_viridis_d(option = "B", end = 0.85) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none") +
  labs(y = "Frequency of feature selection",
       x = "Date update")
```
